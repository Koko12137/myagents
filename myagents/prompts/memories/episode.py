EPISODE_MEMORY_EXTRACT_PROMPT = """
## 事件记忆提取任务
【从上下文中提取事件反馈记忆信息，并判断操作类型】

请从当前的上下文中提取**事件记忆（episode memory）**，即事件发生过程中产生的反馈（如结果、感受、影响等），与具体情境相关。同时需要判断与历史记忆是否存在冲突，并决定相应的操作类型。

### 记忆定义
**事件记忆**：事件发生过程中产生的反馈，包括：
- 事件结果（如"任务完成"、"报告被退回"）
- 情感反馈（如"感到失望"、"获得表扬"）
- 影响评估（如"导致项目延期"、"提高了效率"）
- 状态反馈（如"尚未收到回复"、"正在等待审批"）

### 事件记忆更新阶段
事件记忆按时间顺序分三个阶段进行更新，每个阶段只能记录当前阶段的信息：

1. **行动阶段**：记录具体做了什么
   - 内容：描述执行的具体行动和操作
   - 此时还不知道结果，也无法进行反思

2. **结果阶段**：记录行动的结果
   - 内容：描述获得的结果和反馈
   - 此时可以知道结果，但还未进行反思

3. **反思阶段**：记录对行动的反思
   - 内容：描述对之前行动和结果的反思
   - 此时可以对整个事件进行完整的分析和思考

### 事件记忆提取要求
根据当前上下文所处的阶段，提取相应的事件记忆：
- **行动阶段**：只记录做了什么，不包含结果和反思
- **结果阶段**：记录结果是什么，可以包含对结果的初步评估
- **反思阶段**：记录对之前行动和结果的完整反思

### 冲突检测规则
请对比历史记忆与当前上下文，判断是否存在冲突：

1. **结果冲突**：相同事件但结果描述不一致（如历史记忆"任务成功完成"，当前信息"任务失败"）
2. **情感冲突**：相同事件但情感反馈相反（如历史记忆"感到满意"，当前信息"感到失望"）
3. **状态冲突**：相同事件但状态描述不一致（如历史记忆"正在等待"，当前信息"已经完成"）
4. **影响冲突**：相同事件但影响评估不一致（如历史记忆"提高了效率"，当前信息"降低了效率"）

### 操作类型判断
- `"add"`：新事件反馈，历史记忆中不存在相关内容
- `"update"`：存在冲突，需要用新反馈更新历史记忆
- `"delete"`：**注意：事件记忆不允许删除操作，删除动作将被记录用于强化学习**

### 重要提醒
**事件记忆删除限制**：事件记忆是重要的学习资源，不允许执行删除操作。任何删除事件记忆的尝试都将被记录并用于强化学习，以改进记忆管理策略。请专注于添加新记忆或更新现有记忆。

### 输出格式
请以 **JSONL格式** 输出结果（每行一个独立JSON对象），包含以下字段：

- `operation`：操作类型，取值为 `"add"` 或 `"update"`（不允许 `"delete"`）
- 当 `operation` 为 `"add"` 或 `"update"` 时，需要包含 `memory` 字段：
  - `memory`：记忆对象，包含以下字段：
    - `memory_type`：固定为 `"episode_memory"`
    - `content`：提取的事件反馈内容（根据当前阶段记录相应信息）
    - `positive_impact`：表明反馈的积极与否，取值为：
      - `"true"`：积极反馈（如成功、表扬、满意等）
      - `"false"`：消极反馈（如失败、批评、失望等）
      - `"none"`：未知/中性反馈（如等待中、进行中等）

### 示例
**历史记忆**：
```json
{{"memory_id": 12345, "memory_type": "episode_memory", "content": "提交了项目报告", "positive_impact": "none"}}
{{"memory_id": 12346, "memory_type": "episode_memory", "content": "项目报告获得领导表扬", "positive_impact": "true"}}
{{"memory_id": 12347, "memory_type": "episode_memory", "content": "这次报告准备充分，格式规范，领导对内容很满意", "positive_impact": "true"}}
```

**当前上下文**："提交的报告被退回修改，团队感到失望。项目最终按时完成，大家都很满意。会议被取消了。"

**提取结果**：
```json
[
   {{"operation": "update", "memory": {{"memory_type": "episode_memory", "content": "提交的报告被退回修改", "positive_impact": "false"}}}}
   {{"operation": "update", "memory": {{"memory_type": "episode_memory", "content": "项目按时完成，大家都很满意", "positive_impact": "true"}}}}
]
```
【警告】：必须是Jsonl格式，否则会报错！

### 注意事项
- 仔细对比历史记忆与当前信息，准确判断冲突情况
- 根据当前阶段记录相应的信息，不要超前记录
- 若没有相关事件记忆，无需输出任何内容
- **重要：事件记忆不允许删除操作**
- 操作类型必须准确反映与历史记忆的关系

=============

## 相似记忆
{sim_memories}

=============
现在，请从以下上下文中提取事件记忆，并判断操作类型：
"""

# 单个记忆项的格式化模板
EPISODE_ITEM_FORMAT = """
**事件记忆 {memory_id}**：
{content}

**影响评估**：{positive_impact}

---
"""

# 总体记忆组装模板
EPISODE_FORMAT = """
## 历史事件记忆回顾
【基于历史事件反馈指导当前决策】

以下是相关的历史事件记忆，请参考这些经验来指导当前的任务执行：

{memory_items}

### 记忆使用指导
- **积极影响记忆**：参考历史成功经验，采用类似的有效策略
- **消极影响记忆**：避免重复历史中的错误做法，调整执行方式
- **中性经验记忆**：作为一般性参考，结合当前具体情况灵活运用

### 决策建议
1. **借鉴成功模式**：从积极影响的事件中提取有效方法
2. **规避风险点**：从消极影响的事件中识别潜在问题
3. **优化执行策略**：根据历史反馈调整当前操作方案
4. **保持适应性**：结合当前环境特点，灵活应用历史经验

请基于以上历史记忆，为当前任务提供具体的执行建议和注意事项。
"""
